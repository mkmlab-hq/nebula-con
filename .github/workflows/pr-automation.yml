name: PR Automation & Quality Gate
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - 'README.md'
  pull_request_review:
    types: [submitted, dismissed, edited]

jobs:
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort mypy
      
      - name: Code formatting check (Black)
        run: |
          black --check --diff .
      
      - name: Import sorting check (isort)
        run: |
          isort --check-only --diff .
      
      - name: Linting (Flake8)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics
      
      - name: Type checking (MyPy)
        run: |
          mypy --ignore-missing-imports --no-strict-optional .
      
      - name: Security scan
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan
          path: bandit-report.json

  # 2. ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  auto-test:
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run unit tests
        run: |
          python -m pytest tests/ -v --cov=. --cov-report=xml
      
      - name: Upload coverage report
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
      
      - name: Run integration tests
        run: |
          python baseline_model_training.py --test-only
        continue-on-error: true

  # 3. ìë™ ë¦¬ë·°ì–´ í• ë‹¹
  auto-assign:
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.type != 'Bot'
    steps:
      - name: Auto-assign reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            // PR í¬ê¸°ì— ë”°ë¥¸ ë¦¬ë·°ì–´ ìˆ˜ ì¡°ì •
            const changedFiles = pullRequest.changed_files;
            let requiredReviewers = 1;
            
            if (changedFiles > 10) requiredReviewers = 2;
            if (changedFiles > 50) requiredReviewers = 3;
            
            // íŒ€ ë©¤ë²„ ì¤‘ì—ì„œ ë¦¬ë·°ì–´ í• ë‹¹
            const teamMembers = ['mkmlab-v2']; // ì‹¤ì œ íŒ€ ë©¤ë²„ë¡œ ìˆ˜ì • í•„ìš”
            
            const reviewers = teamMembers.slice(0, requiredReviewers);
            
            await github.rest.pulls.requestReviewers({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              reviewers: reviewers,
            });
            
            console.log(`Assigned ${reviewers.length} reviewers: ${reviewers.join(', ')}`);

  # 4. ìë™ ë¼ë²¨ë§
  auto-label:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-label PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const labels = [];
            
            // íŒŒì¼ ë³€ê²½ ìœ í˜•ì— ë”°ë¥¸ ë¼ë²¨ë§
            const changedFiles = pullRequest.files;
            
            if (changedFiles.some(file => file.filename.includes('test'))) {
              labels.push('testing');
            }
            
            if (changedFiles.some(file => file.filename.includes('docs'))) {
              labels.push('documentation');
            }
            
            if (changedFiles.some(file => file.filename.includes('requirements'))) {
              labels.push('dependencies');
            }
            
            if (changedFiles.some(file => file.filename.includes('workflow'))) {
              labels.push('ci-cd');
            }
            
            // PR í¬ê¸°ì— ë”°ë¥¸ ë¼ë²¨ë§
            if (pullRequest.additions + pullRequest.deletions > 100) {
              labels.push('large-change');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels,
              });
              
              console.log(`Added labels: ${labels.join(', ')}`);
            }

  # 5. ìë™ ë¨¸ì§€ ì¤€ë¹„ ê²€ì‚¬
  merge-readiness:
    runs-on: ubuntu-latest
    needs: [code-quality, auto-test]
    if: github.event.pull_request.state == 'open'
    steps:
      - name: Check merge readiness
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pullRequest.head.sha,
            });
            
            let status = 'âœ… Ready to merge';
            let comment = '## ğŸš€ PR ë¨¸ì§€ ì¤€ë¹„ ì™„ë£Œ!\n\n';
            
            // ì²´í¬ ìƒíƒœ í™•ì¸
            const failedChecks = checks.check_runs.filter(check => check.conclusion === 'failure');
            if (failedChecks.length > 0) {
              status = 'âŒ Checks failed';
              comment += `### âŒ ì‹¤íŒ¨í•œ ì²´í¬:\n`;
              failedChecks.forEach(check => {
                comment += `- ${check.name}: ${check.conclusion}\n`;
              });
            }
            
            // ë¦¬ë·° ìƒíƒœ í™•ì¸
            const approvedReviews = reviews.filter(review => review.state === 'APPROVED');
            if (approvedReviews.length === 0) {
              status = 'â³ Waiting for review';
              comment += `\n### â³ ë¦¬ë·° ëŒ€ê¸° ì¤‘\n`;
            } else {
              comment += `\n### âœ… ìŠ¹ì¸ëœ ë¦¬ë·°: ${approvedReviews.length}ê°œ\n`;
            }
            
            // PR ìƒíƒœ ì—…ë°ì´íŠ¸
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment,
            });
            
            console.log(`PR Status: ${status}`);

  # 6. ìë™ ë°°í¬ ì¤€ë¹„ (ì„ íƒì )
  deploy-prep:
    runs-on: ubuntu-latest
    needs: [code-quality, auto-test]
    if: github.event.pull_request.merged == true
    steps:
      - name: Prepare deployment
        run: |
          echo "ğŸš€ PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë°°í¬ ì¤€ë¹„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
          echo "ë°°í¬ í™˜ê²½: ${{ github.ref_name }}"
          
      - name: Create deployment tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "v$(date +%Y%m%d-%H%M%S)" -m "Auto-deploy from PR #${{ github.event.pull_request.number }}"
          git push origin "v$(date +%Y%m%d-%H%M%S)" 