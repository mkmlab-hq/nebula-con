# .github/workflows/pr-auto-merge.yml
# PR ìë™ ë³‘í•©: í•˜ë£¨ 2íšŒ ì •ì‹œ ì§‘í–‰
#
# - ì˜¤ì „ 09:00, ì˜¤í›„ 18:00ì— CI í†µê³¼ PR ìë™ ë³‘í•©
# - ê°œë°œìì˜ í•µì‹¬ ì„ë¬´ ì§‘ì¤‘ ë³´ì¥
# - ì²´ê³„ì ì¸ PR ê´€ë¦¬ ë° ë³´ê³ 

name: PR Auto Merge

on:
  schedule:
    # ì˜¤ì „ ì„¸ì…˜: ì˜¤ì „ ì—…ë¬´ ì‹œì‘ ì§ì „
    - cron: "0 9 * * 1-5"  # í‰ì¼ ì˜¤ì „ 9ì‹œ
    # ì˜¤í›„ ì„¸ì…˜: ì˜¤í›„ ì—…ë¬´ ì¢…ë£Œ ì§ì „  
    - cron: "0 18 * * 1-5" # í‰ì¼ ì˜¤í›„ 6ì‹œ
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  auto-merge:
    name: "ğŸ”„ PR ìë™ ë³‘í•©"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” CI í†µê³¼ PR ëª©ë¡ ì¡°íšŒ
        id: pr-list
        run: |
          echo "ğŸ” CIë¥¼ í†µê³¼í•œ PR ëª©ë¡ ì¡°íšŒ ì¤‘..."
          
          # CI í†µê³¼í•œ PR ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          PRS=$(gh pr list --repo ${{ github.repository }} --state open --json number,title,author,createdAt,labels,mergeable,reviewDecision,statusCheckRollup --jq "[.[] | select(.statusCheckRollup[]?.conclusion == \"success\")]")
          
          if [ "$PRS" = "[]" ]; then
            echo "::notice title=PR ì—†ìŒ::CIë¥¼ í†µê³¼í•œ PRì´ ì—†ìŠµë‹ˆë‹¤."
            echo "pr_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "::notice title=PR ë°œê²¬::CI í†µê³¼ PR: $(echo $PRS | jq length)ê°œ"
          echo "pr_count=$(echo $PRS | jq length)" >> $GITHUB_OUTPUT
          
          # PR ì •ë³´ë¥¼ íŒŒì¼ì— ì €ì¥
          echo "$PRS" > prs_to_merge.json
          echo "prs_file=prs_to_merge.json" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ ë³‘í•© ëŒ€ìƒ PR ìš”ì•½
        if: steps.pr-list.outputs.pr_count != "0"
        run: |
          echo "ğŸ“‹ ë³‘í•© ëŒ€ìƒ PR ìš”ì•½:"
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ”„ ë³‘í•© ëŒ€ìƒ PR ëª©ë¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          jq -r ".[] | \"- **#\(.number)**: \(.title) (ì‘ì„±ì: \(.author.login))\"" prs_to_merge.json >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì´ \(jq length prs_to_merge.json)ê°œì˜ PRì´ ë³‘í•© ëŒ€ìƒì…ë‹ˆë‹¤.**" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”„ PR ìë™ ë³‘í•© ì‹¤í–‰
        if: steps.pr-list.outputs.pr_count != "0"
        run: |
          echo "ğŸ”„ PR ìë™ ë³‘í•© ì‹œì‘..."
          
          # ê° PRì— ëŒ€í•´ ë³‘í•© ì‹œë„
          jq -c ".[]" prs_to_merge.json | while read -r pr; do
            pr_number=$(echo $pr | jq -r ".number")
            pr_title=$(echo $pr | jq -r ".title")
            
            echo "ğŸ”„ PR #$pr_number ë³‘í•© ì‹œë„: $pr_title"
            
            # PR ë³‘í•© (squash ë°©ì‹)
            if gh pr merge $pr_number --squash --delete-branch --repo ${{ github.repository }}; then
              echo "âœ… PR #$pr_number ë³‘í•© ì„±ê³µ"
              echo "âœ… PR #$pr_number ë³‘í•© ì™„ë£Œ: $pr_title" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ PR #$pr_number ë³‘í•© ì‹¤íŒ¨"
              echo "âŒ PR #$pr_number ë³‘í•© ì‹¤íŒ¨: $pr_title" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: ğŸ“Š ë³‘í•© ê²°ê³¼ ìš”ì•½
        if: steps.pr-list.outputs.pr_count != "0"
        run: |
          echo "ğŸ“Š ë³‘í•© ì‘ì—… ì™„ë£Œ ìš”ì•½:"
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š ë³‘í•© ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹¤í–‰ ì‹œê°„:** $(date \"+%Y-%m-%d %H:%M:%S\")" >> $GITHUB_STEP_SUMMARY
          echo "**ì„¸ì…˜:** ${{ github.event_name == \"schedule\" && (github.event.schedule == \"0 9 * * 1-5\" && \"ì˜¤ì „\" || \"ì˜¤í›„\") || \"ìˆ˜ë™\" }} ì„¸ì…˜" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì´ ì²˜ë¦¬ PR:** ${{ steps.pr-list.outputs.pr_count }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**ë‹¤ìŒ ì„¸ì…˜:** ${{ github.event.schedule == \"0 9 * * 1-5\" && \"ì˜¤í›„ 18:00\" || \"ì˜¤ì „ 09:00\" }}" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬
        if: always()
        run: |
          if [ -f "prs_to_merge.json" ]; then
            rm -f prs_to_merge.json
          fi
