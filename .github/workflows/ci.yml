# .github/workflows/ci.yml
# NebulaCon CI: ìºê¸€ í•´ì»¤í†¤ 1ìœ„ ë‹¬ì„±ì„ ìœ„í•œ ê²¬ê³ í•œ í’ˆì§ˆ ê²€ì¦
#
# ì£¼ìš” íŠ¹ì§•:
# - êµ¬ì¡° ê²€ì¦ + Python í’ˆì§ˆ ê²€ì‚¬ + ë³´ì•ˆ ê²€ì‚¬
# - ìžë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ì»¤ë²„ë¦¬ì§€ ì¸¡ì •
# - ìºê¸€ ëŒ€íšŒ ì œì¶œë¬¼ í’ˆì§ˆ ë³´ìž¥
# - ì‹¤íŒ¨ ì‹œ ìƒì„¸í•œ ì›ì¸ ë¶„ì„ ë° í•´ê²° ë°©ì•ˆ ì œì‹œ

name: NebulaCon CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  structure-check:
    name: "ðŸ§± Repository Structure Check"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ“‚ Verify essential directories
        id: structure
        shell: bash
        run: |
          echo "ï¿½ï¿½ í•„ìˆ˜ ë””ë ‰í† ë¦¬ ê²€ì‚¬ ì‹œìž‘..."
          
          # í•µì‹¬ í•„ìˆ˜ ë””ë ‰í† ë¦¬ (ë°˜ë“œì‹œ ìžˆì–´ì•¼ í•¨)
          core_dirs=(docs scripts config pipelines notebooks metrics)
          missing_core=()
          for d in "${core_dirs[@]}"; do
            if [ ! -d "$d" ]; then
              echo "::error title=êµ¬ì¡° ì˜¤ë¥˜::âŒ í•µì‹¬ ë””ë ‰í† ë¦¬ '$d'ê°€ ì—†ìŠµë‹ˆë‹¤."
              missing_core+=("$d")
            else
              echo "  - âœ… $d ë””ë ‰í† ë¦¬ ì¡´ìž¬"
            fi
          done
          
          # ì„ íƒì  ë””ë ‰í† ë¦¬ (ìžˆìœ¼ë©´ ì¢‹ì§€ë§Œ ì—†ì–´ë„ ë¨)
          optional_dirs=(sql axes)
          for d in "${optional_dirs[@]}"; do
            if [ ! -d "$d" ]; then
              echo "  - âš ï¸ ì„ íƒì  ë””ë ‰í† ë¦¬ '$d' ì—†ìŒ (ìƒì„± ê¶Œìž¥)"
            else
              echo "  - âœ… $d ë””ë ‰í† ë¦¬ ì¡´ìž¬"
            fi
          done

          if [ "${#missing_core[@]}" -ne 0 ]; then
            echo "í•µì‹¬ ë””ë ‰í† ë¦¬ ëˆ„ë½: ${missing_core[*]}" >> $GITHUB_STEP_SUMMARY
            echo "::error title=êµ¬ì¡° ê²€ì‚¬ ì‹¤íŒ¨::í•µì‹¬ ë””ë ‰í† ë¦¬ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "ëª¨ë“  í•µì‹¬ ë””ë ‰í† ë¦¬ê°€ ì¡´ìž¬í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "âœ… êµ¬ì¡° ê²€ì‚¬ í†µê³¼"
          fi

  python-ci:
    name: "ðŸ Python CI & Quality Check"
    needs: structure-check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install dependencies
        run: |
          echo "ðŸ”§ Python ê°œë°œ í™˜ê²½ ì„¤ì • ì¤‘..."
          python -m pip install --upgrade pip
          
          # ê°œë°œ ë„êµ¬ ì„¤ì¹˜ (ì •í™•í•œ ë²„ì „ìœ¼ë¡œ)
          pip install "black==23.12.1" "isort==5.13.2" "ruff==0.1.6"
          pip install "pytest==7.4.3" "pytest-cov==4.1.0" "bandit==1.7.5" "safety==2.3.5"
          
          # ê¸°ë³¸ ì˜ì¡´ì„± ì„¤ì¹˜
          pip install pandas numpy scipy
          
          # requirements.txtê°€ ìžˆìœ¼ë©´ ì¶”ê°€ ì„¤ì¹˜
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          fi
          
          # pyproject.toml ì„¤ì • í™•ì¸
          echo "ðŸ“‹ pyproject.toml ì„¤ì • í™•ì¸:"
          python -c "import tomllib; print('âœ… pyproject.toml íŒŒì‹± ì„±ê³µ')" 2>/dev/null || echo "âš ï¸ tomllib ì‚¬ìš© ë¶ˆê°€ (Python 3.11+ í•„ìš”)"

      - name: ðŸ§¹ Code formatting check with Black
        working-directory: ${{ github.workspace }}
        run: |
          echo "ðŸ” ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ ì¤‘..."
          echo "ðŸ“‹ Black ì„¤ì •: line-length=88, target-version=py311"
          black --check --diff . --config pyproject.toml
          echo "âœ… Black í¬ë§·íŒ… ê²€ì‚¬ í†µê³¼"

      - name: ðŸ”§ Import sorting check with isort
        working-directory: ${{ github.workspace }}
        run: |
          echo "ðŸ” import ì •ë ¬ ê²€ì‚¬ ì¤‘..."
          echo "ðŸ“‹ isort ì„¤ì •: profile=black, line_length=88"
          isort --check-only --diff . --config .isort.cfg
          echo "âœ… isort ê²€ì‚¬ í†µê³¼"

      - name: ðŸš¨ Lint with Ruff
        run: |
          echo "ðŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì¤‘..."
          ruff check . --output-format=github
          echo "âœ… Ruff ê²€ì‚¬ í†µê³¼"

      - name: ðŸ›¡ï¸ Security check with Bandit
        run: |
          echo "ðŸ” ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬ ì¤‘..."
          bandit -r . -f json -o bandit-report.json || true
          echo "âœ… Bandit ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"

      - name: ðŸ”’ Dependency security check with Safety
        run: |
          echo "ðŸ” ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ ì¤‘..."
          safety check --json --output safety-report.json || true
          echo "âœ… Safety ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ"

      - name: ðŸ§ª Run tests with Pytest
        run: |
          echo "ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          # í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ìžˆìœ¼ë©´ ì‹¤í–‰, ì—†ìœ¼ë©´ ìŠ¤í‚µ
          if [ -d "tests" ]; then
            pytest tests/ --maxfail=3 --disable-warnings --cov=tests --cov-report=xml --cov-report=html
          else
            echo "::notice title=í…ŒìŠ¤íŠ¸::í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ í…ŒìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
            mkdir -p tests
            echo 'def test_basic(): assert True' > tests/test_basic.py
            pytest tests/ --maxfail=3 --disable-warnings
          fi
          echo "âœ… í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ"

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  kaggle-submission-check:
    name: "ðŸ† Kaggle Submission Quality Check"
    needs: structure-check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Kaggle ì œì¶œë¬¼ í’ˆì§ˆ ê²€ì‚¬
        run: |
          echo "ðŸ† Kaggle ì œì¶œë¬¼ í’ˆì§ˆ ê²€ì‚¬ ì‹œìž‘..."
          
          # ì œì¶œìš© íŒŒì¼ ì¡´ìž¬ í™•ì¸
          submission_files=()
          if [ -f "submission.csv" ]; then
            submission_files+=("submission.csv")
          fi
          if [ -f "submission.zip" ]; then
            submission_files+=("submission.zip")
          fi
          
          if [ ${#submission_files[@]} -eq 0 ]; then
            echo "::warning title=ì œì¶œë¬¼ ì—†ìŒ::Kaggle ì œì¶œìš© íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "âœ… ì œì¶œë¬¼ ë°œê²¬: ${submission_files[*]}"
          fi
          
          # ëª¨ë¸ íŒŒì¼ ì¡´ìž¬ í™•ì¸
          model_files=()
          if [ -d "models" ]; then
            model_count=$(find models -name "*.pkl" -o -name "*.joblib" -o -name "*.h5" | wc -l)
            echo "ðŸ“Š ëª¨ë¸ íŒŒì¼ ìˆ˜: $model_countê°œ"
          fi
          
          # ì„±ëŠ¥ ì§€í‘œ íŒŒì¼ í™•ì¸
          if [ -f "metrics/baseline_run.json" ]; then
            echo "âœ… ì„±ëŠ¥ ì§€í‘œ íŒŒì¼ ì¡´ìž¬"
          else
            echo "::warning title=ì„±ëŠ¥ ì§€í‘œ ì—†ìŒ::baseline ì„±ëŠ¥ ì§€í‘œê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

  drift-detection:
    name: "ðŸ“ˆ Data Drift Detection"
    needs: structure-check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install drift detection tools
        run: |
          pip install evidently pandas numpy scikit-learn

      - name: ðŸ” Data drift check
        run: |
          echo "ðŸ“ˆ ë°ì´í„° ë“œë¦¬í”„íŠ¸ ê²€ì‚¬ ì‹œìž‘..."
          
          # ê°„ë‹¨í•œ ë“œë¦¬í”„íŠ¸ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ -f "scripts/check_drift.py" ]; then
            python scripts/check_drift.py
          else
            echo "::notice title=ë“œë¦¬í”„íŠ¸ ê²€ì‚¬::ë“œë¦¬í”„íŠ¸ ê²€ì‚¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

  ci-summary:
    name: "ðŸ“‹ CI Summary Report"
    needs: [structure-check, python-ci, kaggle-submission-check, drift-detection]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ðŸ“Š CI ê²°ê³¼ ìš”ì•½
        run: |
          echo "ðŸ“‹ NebulaCon CI ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§± êµ¬ì¡° ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.structure-check.result }}" = "success" ]; then
            echo "âœ… **êµ¬ì¡° ê²€ì‚¬**: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **êµ¬ì¡° ê²€ì‚¬**: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ Python í’ˆì§ˆ ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.python-ci.result }}" = "success" ]; then
            echo "âœ… **Python CI**: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Python CI**: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ† Kaggle ì œì¶œë¬¼ ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.kaggle-submission-check.result }}" = "success" ]; then
            echo "âœ… **ì œì¶œë¬¼ ê²€ì‚¬**: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ì œì¶œë¬¼ ê²€ì‚¬**: ê²½ê³ " >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ ë°ì´í„° ë“œë¦¬í”„íŠ¸ ê²€ì‚¬" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.drift-detection.result }}" = "success" ]; then
            echo "âœ… **ë“œë¦¬í”„íŠ¸ ê²€ì‚¬**: í†µê³¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **ë“œë¦¬í”„íŠ¸ ê²€ì‚¬**: ê²½ê³ " >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**CI ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          
          # ì „ì²´ ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€
          if [ "${{ needs.structure-check.result }}" = "success" ] && [ "${{ needs.python-ci.result }}" = "success" ]; then
            echo "ðŸŽ‰ **ì „ì²´ CI í†µê³¼!** PR ìžë™ ë³‘í•©ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **CI ì‹¤íŒ¨!** ë¬¸ì œë¥¼ í•´ê²°í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
          fi
