name: NebulaCon Core CI
on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'
jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Generate sample.csv
        run: |
          python - <<'PY'
          import os, numpy as np, pandas as pd, datetime as dt
          np.random.seed(42)
          os.makedirs('data/raw', exist_ok=True)
          start=dt.datetime(2024,1,1)
          ts=[start+dt.timedelta(hours=i) for i in range(500)]
          feat_a=np.random.normal(0,1,500).cumsum()/50 + np.sin(np.arange(500)/15)
          feat_b=np.random.gamma(2,1,500)
          feat_c=np.random.uniform(-1,1,500)
          feat_d=np.random.normal(5,2,500)
          feat_e=np.random.beta(2,5,500)
          y=np.where(feat_a+0.3*feat_b+np.random.normal(0,0.5,500)>1.5,'C1',np.where(feat_d>6,'C2','C3'))
          df=pd.DataFrame({'timestamp':ts,'feat_a':feat_a,'feat_b':feat_b,'feat_c':feat_c,'feat_d':feat_d,'feat_e':feat_e,'target':y})
          df.to_csv('data/raw/sample.csv', index=False)
          print('sample.csv generated')
          PY
      - name: Run axes/profile
        run: |
          python pipelines/dataset_ingest.py --input data/raw/sample.csv --out_axes metrics/axes_run.json --out_profile metrics/profile.json
          test -f metrics/axes_run.json && test -f metrics/profile.json
      - name: Run baseline
        run: |
          python notebooks/_scripts/run_baseline.py --data data/raw/sample.csv --out data/baseline_run.json
          test -f data/baseline_run.json
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nebula-metrics
          path: |
            metrics/axes_run.json
            metrics/profile.json
            data/baseline_run.json 