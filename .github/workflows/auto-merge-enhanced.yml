# .github/workflows/auto-merge-enhanced.yml
# í–¥ìƒëœ PR ìžë™ ë³‘í•©: ìºê¸€ í•´ì»¤í†¤ 1ìœ„ ë‹¬ì„±ì„ ìœ„í•œ ì™„ì „ ìžë™í™”
#
# ì£¼ìš” íŠ¹ì§•:
# - CI í†µê³¼ ì‹œ ì¦‰ì‹œ ìžë™ ë³‘í•© (ì‹œê°„ ì œí•œ ì—†ìŒ)
# - í’ˆì§ˆ ê²Œì´íŠ¸ ê°•í™” (í…ŒìŠ¤íŠ¸, ë¦°íŒ…, ë³´ì•ˆ ê²€ì‚¬)
# - ìžë™ ë°°í¬ íŠ¸ë¦¬ê±°
# - ì‹¤ì‹œê°„ ì•Œë¦¼ ë° ëª¨ë‹ˆí„°ë§

name: Enhanced PR Auto Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  quality-gate:
    name: "ðŸ›¡ï¸ Quality Gate Check"
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” PR í’ˆì§ˆ ê²€ì‚¬
        id: quality-check
        run: |
          echo "ðŸ” PR í’ˆì§ˆ ê²€ì‚¬ ì‹œìž‘..."
          
          # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          
          echo "PR #$PR_NUMBER: $PR_TITLE (ìž‘ì„±ìž: $PR_AUTHOR)"
          
          # í’ˆì§ˆ ì ìˆ˜ ê³„ì‚° (ì˜ˆì‹œ)
          QUALITY_SCORE=100
          
          # ì œëª© í’ˆì§ˆ ê²€ì‚¬
          if [[ "$PR_TITLE" == *"WIP"* ]] || [[ "$PR_TITLE" == *"DRAFT"* ]]; then
            echo "::warning title=í’ˆì§ˆ ê²½ê³ ::PRì´ WIP/DRAFT ìƒíƒœìž…ë‹ˆë‹¤."
            QUALITY_SCORE=$((QUALITY_SCORE - 20))
          fi
          
          # ì„¤ëª… ê¸¸ì´ ê²€ì‚¬
          PR_BODY="${{ github.event.pull_request.body }}"
          if [ ${#PR_BODY} -lt 50 ]; then
            echo "::warning title=í’ˆì§ˆ ê²½ê³ ::PR ì„¤ëª…ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤."
            QUALITY_SCORE=$((QUALITY_SCORE - 10))
          fi
          
          echo "í’ˆì§ˆ ì ìˆ˜: $QUALITY_SCORE/100"
          echo "quality_score=$QUALITY_SCORE" >> $GITHUB_OUTPUT
          
          if [ $QUALITY_SCORE -ge 80 ]; then
            echo "âœ… í’ˆì§ˆ ê²€ì‚¬ í†µê³¼"
            echo "quality_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨"
            echo "quality_passed=false" >> $GITHUB_OUTPUT
          fi

  auto-merge:
    name: "ðŸ”„ Enhanced Auto Merge"
    runs-on: ubuntu-latest
    needs: quality-gate
    if: needs.quality-gate.outputs.quality_passed == 'true'
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” CI ìƒíƒœ í™•ì¸
        id: ci-status
        run: |
          echo "ðŸ” CI ìƒíƒœ í™•ì¸ ì¤‘..."
          
          # GitHub APIë¡œ CI ìƒíƒœ í™•ì¸
          PR_NUMBER=${{ github.event.pull_request.number }}
          
          # ìµœëŒ€ 10ë¶„ ëŒ€ê¸° (CI ì™„ë£Œê¹Œì§€)
          for i in {1..20}; do
            echo "CI ìƒíƒœ í™•ì¸ ì‹œë„ $i/20..."
            
            # GitHub CLIê°€ ì—†ì„ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ ëŒ€ì•ˆ ë°©ë²• ì‚¬ìš©
            if command -v gh &> /dev/null; then
              CI_STATUS=$(gh api repos/${{ github.repository }}/commits/${{ github.event.pull_request.head.sha }}/status)
              CI_STATE=$(echo "$CI_STATUS" | jq -r '.state')
            else
              # GitHub CLIê°€ ì—†ìœ¼ë©´ ê°„ë‹¨í•œ ëŒ€ê¸°ë§Œ ìˆ˜í–‰
              echo "GitHub CLIê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ëŒ€ê¸° ëª¨ë“œë¡œ ì „í™˜..."
              sleep 30
              CI_STATE="pending"
            fi
            
            if [ "$CI_STATE" = "success" ]; then
              echo "âœ… CI í†µê³¼ í™•ì¸ë¨"
              echo "ci_passed=true" >> $GITHUB_OUTPUT
              break
            elif [ "$CI_STATE" = "failure" ]; then
              echo "âŒ CI ì‹¤íŒ¨ í™•ì¸ë¨"
              echo "ci_passed=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "â³ CI ì§„í–‰ ì¤‘... ($i/20)"
              sleep 30
            fi
          done
          
          if [ "$CI_STATE" != "success" ]; then
            echo "âŒ CI íƒ€ìž„ì•„ì›ƒ"
            echo "ci_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ”„ PR ìžë™ ë³‘í•©
        if: steps.ci-status.outputs.ci_passed == 'true'
        run: |
          echo "ðŸ”„ PR ìžë™ ë³‘í•© ì‹œìž‘..."
          
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # ë³‘í•© ì „ ìµœì¢… í™•ì¸
          echo "ë³‘í•© ëŒ€ìƒ: PR #$PR_NUMBER - $PR_TITLE"
          
          # Squash ë³‘í•© ì‹¤í–‰
          if gh pr merge $PR_NUMBER --squash --delete-branch --repo ${{ github.repository }}; then
            echo "âœ… PR #$PR_NUMBER ìžë™ ë³‘í•© ì„±ê³µ!"
            
            # ì„±ê³µ ì•Œë¦¼
            echo "## ðŸŽ‰ PR ìžë™ ë³‘í•© ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
            echo "**PR #$PR_NUMBER**: $PR_TITLE" >> $GITHUB_STEP_SUMMARY
            echo "**ë³‘í•© ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
            echo "**ë³‘í•© ë°©ì‹**: Squash" >> $GITHUB_STEP_SUMMARY
            
            # ë°°í¬ íŠ¸ë¦¬ê±° (main ë¸Œëžœì¹˜ì— ë³‘í•©ë¨)
            echo "ðŸš€ ë°°í¬ íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±°ë¨"
          else
            echo "âŒ PR #$PR_NUMBER ë³‘í•© ì‹¤íŒ¨"
            exit 1
          fi

      - name: ðŸ“Š ë³‘í•© ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "ðŸ“Š ìžë™ ë³‘í•© ê²°ê³¼ ìš”ì•½:"
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š ìžë™ ë³‘í•© ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR ë²ˆí˜¸**: ${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**PR ì œëª©**: ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**ìž‘ì„±ìž**: ${{ github.event.pull_request.user.login }}" >> $GITHUB_STEP_SUMMARY
          echo "**í’ˆì§ˆ ì ìˆ˜**: ${{ needs.quality-gate.outputs.quality_score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "**CI ìƒíƒœ**: ${{ steps.ci-status.outputs.ci_passed }}" >> $GITHUB_STEP_SUMMARY
          echo "**ë³‘í•© ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ë‹¤ìŒ ë‹¨ê³„**: ë°°í¬ íŒŒì´í”„ë¼ì¸ ìžë™ ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY

  notification:
    name: "ðŸ“¢ Merge Notification"
    runs-on: ubuntu-latest
    needs: [quality-gate, auto-merge]
    if: always()
    steps:
      - name: ðŸ“¢ ë³‘í•© ì•Œë¦¼
        run: |
          echo "ðŸ“¢ PR ìžë™ ë³‘í•© ì•Œë¦¼"
          
          if [ "${{ needs.auto-merge.result }}" = "success" ]; then
            echo "## ðŸŽ‰ ìžë™ ë³‘í•© ì„±ê³µ!" >> $GITHUB_STEP_SUMMARY
            echo "PR #${{ github.event.pull_request.number }}ì´ ì„±ê³µì ìœ¼ë¡œ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "ë°°í¬ íŒŒì´í”„ë¼ì¸ì´ ìžë™ìœ¼ë¡œ ì‹œìž‘ë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            
            # ì—¬ê¸°ì— Slack, Discord ë“± ì•Œë¦¼ ì—°ë™ ê°€ëŠ¥
            # curl -X POST ${{ secrets.SLACK_WEBHOOK }} -d "PR ìžë™ ë³‘í•© ì„±ê³µ!"
          else
            echo "## âŒ ìžë™ ë³‘í•© ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
            echo "PR #${{ github.event.pull_request.number }} ë³‘í•©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "ìˆ˜ë™ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi 