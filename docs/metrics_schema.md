# NebulaCon Metrics Schema

## Overview
This document defines the complete schema for all metrics generated by the NebulaCon system.

## A-Axis: Temporal Stability

### st_var_ratio
- **Type**: float
- **Range**: 0.0 ~ ∞
- **Description**: Rolling variance ratio to global variance
- **Edge Cases**: NaN if < 30 samples
- **Example**: 0.8406 (rolling variance ≈ 84% of global variance)

### seasonal_corr
- **Type**: float
- **Range**: -1.0 ~ 1.0
- **Description**: Autocorrelation at seasonal lag
- **Edge Cases**: NaN if < 30 samples
- **Example**: 0.0106 (very weak seasonal pattern)

### psi_trigger_rate
- **Type**: float
- **Range**: 0.0 ~ ∞
- **Description**: Population Stability Index (half-split baseline vs current)
- **Edge Cases**: 0.0 if < 120 samples
- **Example**: 0.0085 (very stable distribution)

## B-Axis: Distributional Shape

### sk_k_score
- **Type**: float
- **Range**: 0.0 ~ ∞
- **Description**: |skew| + |kurtosis - 3| (deviation from normal)
- **Edge Cases**: None
- **Example**: 4.7326 (significant deviation from normal)

### outlier_ratio
- **Type**: float
- **Range**: 0.0 ~ 1.0
- **Description**: Proportion of outliers (IQR-based)
- **Edge Cases**: None
- **Example**: 0.0 (no outliers detected)

### dip_stat
- **Type**: float | None
- **Range**: 0.0 ~ 1.0
- **Description**: Hartigan Dip Test statistic (unimodality)
- **Edge Cases**: None if < 40 samples, 0.0 if < 3 unique values
- **Example**: 0.0 (unimodal), 0.05+ (potentially multimodal)

## C-Axis: Semantic Density

### intra_cluster_density
- **Type**: float | None
- **Range**: 0.0 ~ 1.0
- **Description**: Mean intra-cluster distance / global reference distance
- **Edge Cases**: None if < 40 samples or < 2 features
- **Example**: 0.9056 (low clustering structure)

### silhouette_approx
- **Type**: float | None
- **Range**: -1.0 ~ 1.0
- **Description**: Approximate silhouette score (inter - intra) / inter
- **Edge Cases**: None if < 40 samples or < 2 features
- **Example**: 0.0 (poor cluster separation)

### density_k
- **Type**: int | None
- **Range**: 2 ~ 6
- **Description**: Optimal number of clusters found
- **Edge Cases**: None if clustering fails
- **Example**: 2 (two clusters optimal)

## D-Axis: Cross-Domain Transferability

### macro_f1_base
- **Type**: float | None
- **Range**: 0.0 ~ 1.0
- **Description**: Baseline macro F1-score on original data
- **Edge Cases**: None if < 200 samples or single class
- **Example**: 0.8097 (baseline performance)

### retention_zero_shot
- **Type**: float | None
- **Range**: 0.0 ~ ∞
- **Description**: Zero-shot performance retention ratio
- **Edge Cases**: None if baseline calculation fails
- **Example**: 0.8255 (82.55% performance retention)

### retention_retrained
- **Type**: float | None
- **Range**: 0.0 ~ ∞
- **Description**: Retrained performance retention ratio
- **Edge Cases**: None if retraining fails
- **Example**: 0.9868 (98.68% performance retention)

## Thresholds

### PSI Thresholds
- **minor**: 0.1 (insignificant drift)
- **moderate**: 0.25 (noticeable drift)
- **major**: 0.5 (significant drift)

### Silhouette Thresholds
- **weak**: 0.0 (poor separation)
- **moderate**: 0.25 (acceptable separation)
- **strong**: 0.5 (good separation)

### Dip Stat Thresholds
- **unimodal_max**: 0.02 (unimodal distribution)
- **multi_modal_suspect**: 0.05 (potentially multimodal)
- **multi_modal_strong**: 0.08 (clearly multimodal)

### Retention Thresholds
- **acceptable**: 0.8 (acceptable degradation)
- **degradation**: 0.65 (significant degradation)
- **expected_min**: 0.9 (expected minimum after retraining)

## Data Types

### Input Requirements
- **Minimum samples**: 40 for most metrics, 120 for PSI, 200 for retention
- **Features**: Numeric (int64, float64, float32)
- **Target**: Categorical or numeric (auto-converted)

### Output Format
- **JSON**: All metrics output as JSON
- **Timestamps**: Unix timestamp (seconds since epoch)
- **Precision**: 4 decimal places for readability
- **Encoding**: UTF-8

## Edge Case Handling

### Insufficient Data
- **< 30 samples**: A-axis metrics return NaN
- **< 40 samples**: C-axis metrics return None
- **< 120 samples**: PSI returns 0.0
- **< 200 samples**: D-axis metrics return None

### Data Quality Issues
- **NaN values**: Automatically removed before calculation
- **Single class**: Classification metrics return None
- **Constant values**: Dip test returns 0.0
- **Empty data**: All metrics return None

### Performance Considerations
- **Large datasets**: KDE grid size scales with data size
- **Memory usage**: Optimized for datasets up to 100k samples
- **Computation time**: Most metrics complete in < 1 second 